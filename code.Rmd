---
title: "Final Project"
last updated: 2/1/18
---

## FINAL PROJECT

```{r Setup}
# Libraries
library(readxl)
library(dplyr)
library(moments)
library(stringr)
library(scales)
library(ggplot2)
library(jsonlite)
library(utils)
library(rgdal)
library(readstata13)

# Functions
getMode = function(aColumn){
  freqTable=table(aColumn)
  maxFrequency=max(freqTable)
  names(freqTable[freqTable==maxFrequency])
}
```

```{r Import Data: Initial}
# Initial data set from 2_15_13
temp = tempfile(fileext = '.xlsx')
dataURL <- "https://github.com/lrsulli/GovAnalytics/raw/master/Data/fp_survey_2_15_13.xlsx"
download.file(dataURL, destfile = temp, mode = 'wb')

data_initial = read_excel(temp, sheet = 1)
head(data_initial,4)
```

```{r Import Data: Recodes}
# Recode file for Q12 and Q22 to Q25
temp = tempfile(fileext = '.xlsx')
dataURL <- "https://github.com/lrsulli/GovAnalytics/raw/master/Data/recode_Q12_Q22toQ25.xlsx"
download.file(dataURL, destfile = temp, mode = 'wb')

data_recode = read_excel(temp, sheet = 1)
head(data_recode,4)
```

```{r Import Data: Addresses}
# Address list data file
temp = tempfile(fileext = '.xlsx')
dataURL <- "https://github.com/lrsulli/GovAnalytics/raw/master/Data/address_list_5_20_13.xlsx"
download.file(dataURL, destfile = temp, mode = 'wb')

data_address = read_excel(temp, sheet = 1)
head(data_address,4)
```

```{r Merge Data: Recodes}
# Prepare recode file
names(data_recode)
data_recode = data_recode[,c(1,5:6,14:15,19:20)]
names(data_recode)[1] <- "STUDYID"
head(data_recode,4)

# Merge recode file with initial data set
data = merge(data_initial, data_recode, by="STUDYID")
```

```{r Merge Data: Addresses}
# Prepare address list file
names(data_address)[1] <- "STUDYID"
head(data_address,4)

# Merge address list
data = merge(data, data_address, by="STUDYID")

data = data.frame(data)
```

```{r Import Data: Census 1}
# First census data file
temp = tempfile(fileext = '.dta')
dataURL <- "https://github.com/lrsulli/Project/raw/master/Population_Data%204_7_17.dta"
download.file(dataURL, destfile = temp, mode = 'wb')

data_census1 = read.dta13(temp)
head(data_census1,4)
```

```{r Merge Data: Census 1}
data = merge(data, data_census1, by="STUDYID")

data = data.frame(data)
```

```{r Import Data: Census 2}
# Second census data file
temp = tempfile(fileext = '.dta')
dataURL <- "https://github.com/lrsulli/Project/raw/master/Census_Data%204_28_17.dta"
download.file(dataURL, destfile = temp, mode = 'wb')

data_census2 = read.dta13(temp)
head(data_census2,4)
```

```{r Merge Data: Census 2}
data = merge(data, data_census2, by="tr10fips")

data = data.frame(data)
```

```{r Import Data: Census 3}
# Third census data file
temp = tempfile(fileext = '.dta')
dataURL<-"https://github.com/lrsulli/Project/raw/master/tract10detroit_povertypop_123mile.dta"
download.file(dataURL, destfile = temp, mode = 'wb')

data_census3 = read.dta13(temp)
head(data_census3,4)
```

```{r Merge Data: Census 3}
data = merge(data, data_census3, by="tr10fips")

data = data.frame(data)
```

```{r Check Variable Names}
names(data)
```

```{r Drop Variables}
# Create a copy of original data set
data_copy = data

# Only keep needed variables
data = data_copy[,c('tr10fips','STUDYID','Q5','Q6_1','Q6_2','Q6_3','Q6_4','Q6_5','Q7','Q8_1','Q8_2','Q8_3','Q8_4','Q8_5','Q8_6','Q8_7','Q8_8','Q9','Q10_1','Q10_2','Q10_3','Q10_4','Q10_5','Q14','Q15_1','Q15_2','Q15_3','Q15_4','Q15_5','Q15_6','Q15_7','Q15_8','Q15_9','Q15_10','Q15_11','Q15_12','Q15_13','Q12RC','povpop10071','povpopd71','povpop_1m',"povpopd711mile","povpop_3m","povpopd713mile","nhwht71","pop71","nhwht711mile","nhwht713mile","blk71","blk711mile","blk713mile","hsp71","hsp711mile","hsp713mile","hhsnapfam271","hhsnapfam171","hhsnapfam2711mile","hh711mile","hhsnapfam2713mile","hh713mile")]
```

```{r Rename Variables}
names(data)

# Rename identification variables
names(data)[1] <- "tract"
names(data)[2] <- "id"

# Rename types of meal programs
names(data)[3] <- "meals"
names(data)[4] <- "hot_meals"
names(data)[5] <- "home_meals" #Home delivered meals
names(data)[6] <- "community_kitchen"
names(data)[7] <- "child_meals"
names(data)[8] <- "meal_other"

# Rename types of grocery programs
names(data)[9] <- "groceries"
names(data)[10] <- "pantry"
names(data)[11] <- "backpack"
names(data)[12] <- "home_groceries" #Home delivered groceries
names(data)[13] <- "mobile_pantry"
names(data)[14] <- "mobile_market"
names(data)[15] <- "supply_other" #Supply food to other programs
names(data)[16] <- "community_garden"
names(data)[17] <- "groceries_other"

# Rename types of food related benefit programs
names(data)[18] <- "food_ben" #Offers food-related benefits
names(data)[19] <- "snap"
names(data)[20] <- "wic"
names(data)[21] <- "school" #School lunch or breakfast
names(data)[22] <- "git" #Gift car or voucher
names(data)[23] <- "food_ben_other"

# Rename types of non-food related benefit programs
names(data)[24] <- "nonfood_ben" #Offers non-food related benefits
names(data)[25] <- "job" #Job training or assistance
names(data)[26] <- "house" #Housing assistance
names(data)[27] <- "utility"
names(data)[28] <- "legal"
names(data)[29] <- "educ" #GED or education assistance
names(data)[30] <- "health"
names(data)[31] <- "counseling"
names(data)[32] <- "trans" #Transportation assistance
names(data)[33] <- "cloth" #Clothing or furniture
names(data)[34] <- "ref" #Referrals to other programs
names(data)[35] <- "medicaid" #Medicaid or CHIP
names(data)[36] <- "money" #Financial, tax prep, budgeting
names(data)[37] <- "nonfood_ben_other"

# Rename number of clients served per month
names(data)[38] <- "clients"
```

```{r Generate Census Variables}
# Generate poverty rate variables
data <- mutate(data, pov_rateT = povpop10071 / povpopd71)
data <- mutate(data, pov_rate1 = povpop_1m / povpopd711mile)
data <- mutate(data, pov_rate3 = povpop_3m / povpopd713mile)

# Generate White demographic variables
data <- mutate(data, white_rateT = nhwht71 / pop71)
data <- mutate(data, white_rate1 = nhwht711mile / povpopd711mile)
data <- mutate(data, white_rate3 = nhwht713mile / povpopd713mile)

# Gnerate Black demographic variables
data <- mutate(data, black_rateT = blk71 / pop71)
data <- mutate(data, black_rate1 = blk711mile / povpopd711mile)
data <- mutate(data, black_rate3 = blk713mile / povpopd713mile)

# Generate Hispanic demographic variables
data <- mutate(data, hisp_rateT = hsp71 / pop71)
data <- mutate(data, hisp_rate1 = hsp711mile / povpopd711mile)
data <- mutate(data, hisp_rate3 = hsp713mile / povpopd713mile)

# Generate SNAP rates
data <- mutate(data, snap_rateT = hhsnapfam271 / hhsnapfam171)
data <- mutate(data, snap_rate1 = hhsnapfam2711mile / hh711mile)
data <- mutate(data, snap_rate3 = hhsnapfam2713mile / hh713mile)

# Split census tract identifyer
str(data$tract)

data <- mutate(data, tract_short = substr(tract, 3, 11))
```

### EXPLORING DICHOTOMOUS DATA

#### Meal Programs

```{r Meals: Distribution}
# Distribution of values
table(data$meals)
```

```{r Meals: Frequencies}
# Relative Frequencies
prop.table(table(data$meals))
```

```{r Meals: Chi Square}
# Are the difference significant?
distribution = table(data$meals)
chisq.test(distribution)
```

```{r Meals: Central Measure}
# Central measurement and dispersion
getMode(data$meals)
```

#### Groceries

```{r Groceries: Distribution}
# Distribution of values
table(data$groceries)
```

```{r Groceries: Frequencies}
# Relative Frequencies
prop.table(table(data$groceries))
```

```{r Groceries: Chi Square}
# Are the difference significant?
distribution = table(data$groceries)
chisq.test(distribution)
```

```{r Groceries: Central Measure}
# Central measurement and dispersion
getMode(data$groceries)
```

#### Food Related Benefits

```{r Food Benefits: Distribution}
# Distribution of values
table(data$food_ben)
```

```{r Food Benefits: Frequencies}
# Relative Frequencies
prop.table(table(data$food_ben))
```

```{r Food Benefits: Chi Square}
# Are the difference significant?
distribution = table(data$food_ben)
chisq.test(distribution)
```

```{r Food Benefits: Central Measure}
# Central measurement and dispersion
getMode(data$food_ben)
```

#### Non-Food Related Benefits

```{r Non-Food Benefits: Distribution}
# Distribution of values
table(data$nonfood_ben)
```

```{r Non-Food Benefits: Frequencies}
# Relative Frequencies
prop.table(table(data$nonfood_ben))
```

```{r Non-Food Benefits: Chi Square}
# Are the difference significant?
distribution = table(data$nonfood_ben)
chisq.test(distribution)
```

```{r Non-Food Benefits: Central Measure}
# Central measurement and dispersion
getMode(data$nonfood_ben)
```

### EXPLORING COUNT VARIABLES

#### Average Number of Clients Served per Month

```{r Clients: Centrality}
# Centrality
summary(data$clients)
```

```{r Clients: Skewness}
# Skewness
skewness(data$clients, na.rm = T)
```

```{r Clients: Kurtosis}
# Kurtosis
kurtosis(data$clients, na.rm = T)
```

```{r Clients: Histogram}
# Histogram
hist(data$clients)
hist(log(data$clients))
```

### Mapping

```{r}
compressedMap= "https://github.com/lrsulli/Project/raw/master/map/2010_Census_Tracts_v17a.zip"
```

```{r}
temp=tempfile()
download.file(compressedMap, temp)
unzip(temp)
```

```{r}
(maps = list.files(pattern = 'shp'))
```

```{r}
tractMap <- rgdal::readOGR("2010_Census_Tracts_v17a.shp", stringsAsFactors=F)
```

```{r}
names(tractMap)
```

```{r}
str(tractMap$LINK)
```

```{r}
tractMap$NAME=as.numeric(tractMap$LINK)
```

```{r}
map_final = merge(data, tractMap, by.x='tract_short', by.y='LINK', all.x=F)
```

```{r}
plot(tractMap,col='black')
```

